# Usecases by レイヤードアーキテクチャ

## 概要
このパッケージには、POS QRシステムのビジネスロジック層（ユースケース層）が含まれています。

## テスト実装状況

### ✅ テスト完了済みユースケース
すべてのユースケースについてテスト実装が完了しており、テスト結果はすべて成功しています。

| ユースケース | テストファイル | ステータス |
| ------------ | -------------- | ---------- |
| Manager Sign | `manager_sign_test.go` | ✅ 完了・成功 |
| Manager Store | `manager_store_test.go` | ✅ 完了・成功 |
| Session | `session_test.go` | ✅ 完了・成功 |

## チーム開発規範

### テスト実装について
- **必須**: 新しいユースケースを追加する際は、対応するテストファイル（`*_test.go`）を必ず作成してください
- **品質保証**: すべてのテストが成功することを確認してからコミットしてください
- **カバレッジ**: ユースケースの主要な機能とエッジケースをカバーするテストを実装してください
- **命名規則**: テストファイルは `{usecase_name}_test.go` の形式で命名してください
- **モック使用**: 外部依存（Firestore等）はモックリポジトリを使用してテストしてください

### テスト実行方法
```bash
# 全テスト実行
go test -v

# 特定のユースケースのテスト実行
go test -v -run TestManagerSignUp

# カバレッジ付きテスト実行
go test -cover -v
```

### 継続的品質管理
- 新機能追加時は対応するテストケースも追加してください
- リファクタリング後は既存テストがすべて通ることを確認してください
- テストの保守性を考慮し、適切なモックとアサーションを使用してください

## テスト詳細

### Manager Sign Tests (`manager_sign_test.go`)
マネージャーの認証機能に関するテスト群

#### TestManagerSignUp
- ✅ 正常なマネージャー登録
- ✅ 空のメールアドレスでの登録
- ✅ 空のパスワードでの登録
- ✅ 非常に長いパスワードでの登録（bcrypt制限テスト）
- ✅ 特殊文字を含むメールアドレス
- ✅ Unicode文字を含むパスワード

#### TestManagerSignIn
- ✅ 正常なマネージャーサインイン
- ✅ 存在しないメールアドレスでのサインイン
- ✅ 間違ったパスワードでのサインイン
- ✅ 空のメールアドレスでのサインイン
- ✅ 空のパスワードでのサインイン

#### TestManagerSignUpIntegration
- ✅ 登録後の同一認証情報でのサインイン統合テスト

#### TestPasswordHashing
- ✅ パスワードハッシュ化の正常動作
- ✅ パスワード検証の正常動作

#### TestEdgeCases
- ✅ コンテキストキャンセル時の動作（登録・サインイン）
- ✅ nilユースケースでのパニック処理

#### TestInputValidation
- ✅ 各種入力値パターンでのバリデーション

### Manager Store Tests (`manager_store_test.go`)
店舗管理機能に関するテスト群

#### TestRegisterStore
- ✅ 正常な店舗登録
- ✅ 空の店舗名での登録
- ✅ 空のメールアドレスでの登録
- ✅ 空のパスワードでの登録（エラー期待）

#### TestGetStore
- ✅ IDによる店舗取得
- ✅ 空のIDでの店舗取得（エラー期待）

#### TestGetAllStores
- ✅ 全店舗の取得

#### TestUpdate
- ✅ パスワード付きでの店舗更新
- ✅ パスワードなしでの店舗更新
- ✅ 空のIDでの店舗更新（エラー期待）

#### TestDelete
- ✅ 店舗削除
- ✅ 空のIDでの店舗削除（エラー期待）

#### TestStoreModelCreation
- ✅ 店舗モデルの作成
- ✅ パスワードハッシュ化
- ✅ 空のパスワードでのハッシュ化（エラー期待）

#### TestUpdateLogic
- ✅ 更新ロジックの検証（パスワード有り・無し）

### Session Tests (`session_test.go`)
セッション管理機能に関するテスト群

#### TestNewSession
- ✅ 有効なパラメータでのセッション作成
- ✅ 空の店舗IDでのセッション作成
- ✅ 空の席IDでのセッション作成
- ✅ 過去の有効期限でのセッション作成
- ✅ ゼロ時刻でのセッション作成

#### TestSessionCreateJWT
- ✅ 有効なセッションとJWTシークレットでのJWT作成
- ✅ JWTシークレットなしでのJWT作成（エラー期待）
- ✅ 空のJWTシークレットでのJWT作成（エラー期待）
- ✅ 期限切れセッションでのJWT作成
- ✅ nilストアでのJWT作成（パニック期待）
- ✅ nil席でのJWT作成（パニック期待）
- ✅ 同一セッションからの複数JWT作成（異なるトークン生成確認）

#### TestSessionStructure
- ✅ セッション構造体のフィールド確認
- ✅ セッションフィールドの変更可能性確認

#### TestSessionTimeHandling
- ✅ 未来の有効期限でのセッション
- ✅ 非常に長い有効期限でのセッション
- ✅ 特定の時刻フォーマットでのセッション

## アーキテクチャ設計

### 依存性注入とモック
- `New(nil)` でテスト用モックリポジトリを自動注入
- 実際のFirestore接続なしでのユニットテスト実現
- モックを使用した外部依存の分離
- UseCaseからdbフィールドを削除し、リポジトリ層での依存性管理に統一

### エラーハンドリング
- 適切なエラーメッセージの返却
- バリデーションエラーの適切な処理
- パニック処理の適切なテスト

### セキュリティ
- パスワードハッシュ化の確実な実装
- JWT生成時のセキュリティ考慮
- 認証情報の適切な検証

## 実装上の注意点
- モックリポジトリの期待値設定を忘れずに行ってください
- パスワード関連の処理では適切なバリデーションを実装してください
- JWT生成時は環境変数`JWT_SECRET`の設定を確認してください
- コンテキストキャンセレーションを適切に処理してください
- UseCaseはリポジトリ層のみに依存し、直接的なDB接続は持ちません
- テスト時は`New(nil)`でモックリポジトリが自動的に注入されます